name: PROJECT-Android-Synology-CICD

on:
  push:
    branches: ["deploy"]
  workflow_run:
    workflows: ["CHANGELOG ÏûêÎèô ÏóÖÎç∞Ïù¥Ìä∏"]
    types: [completed]
    branches: [main]
  workflow_dispatch: # ÏàòÎèô Ïã§Ìñâ ÏòµÏÖò Ï∂îÍ∞Ä

# ============================================
# üîß ÌîÑÎ°úÏ†ùÌä∏Î≥Ñ ÏÑ§Ï†ï (ÏïÑÎûò Í∞íÎì§ÏùÑ ÏàòÏ†ïÌïòÏÑ∏Ïöî)
# ============================================
env:
  # ÌîÑÎ°úÏ†ùÌä∏ Ïù¥Î¶Ñ (APK ÌååÏùºÎ™Ö, ÏïÑÌã∞Ìå©Ìä∏Î™Ö, ÌûàÏä§ÌÜ†Î¶¨ ÌååÏùºÎ™ÖÏóê ÏÇ¨Ïö©)
  PROJECT_NAME: "your-project"
  FLUTTER_VERSION: "3.35.5"
  JAVA_VERSION: "17"
  # SMB ÏÑúÎ≤Ñ ÏÑ§Ï†ï (Synology NAS)
  SMB_PORT: "44445" # Í∏∞Î≥∏ 445
  SMB_SHARE: "web"
  SMB_PATH_IOS: "/your-project/ios/download" # SMB Í≤ΩÎ°ú: /{PROJECT_NAME}/ios/download ÌòïÏãùÏúºÎ°ú ÏÇ¨Ïö©
jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    # CHANGELOG ÏõåÌÅ¨ÌîåÎ°úÏö∞Í∞Ä ÏÑ±Í≥µÌïú Í≤ΩÏö∞ÏóêÎßå Ïã§Ìñâ
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name != 'workflow_run' }}

    steps:
      # Repository Ï≤¥ÌÅ¨ÏïÑÏõÉ Î∞è Î™©Î°ù Ï∂úÎ†•
      - name: Check out repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: List repository contents
        run: |
          echo "Repository checked out"
          ls -la

      # Debug Keystore ÏÑ§Ï†ï (ÎîîÎ≤ÑÍπÖ Ïö©ÎèÑ Ïú†ÏßÄ)
      - name: Setup Debug Keystore
        run: |
          mkdir -p ~/.android
          echo "${{ secrets.DEBUG_KEYSTORE }}" | base64 -d > ~/.android/debug.keystore || echo "Base64 decoding failed"
          echo "Debug Keystore created (for debugging)"
          ls -la ~/.android/
          keytool -list -v -keystore ~/.android/debug.keystore -alias androiddebugkey -storepass android -keypass android || echo "Keytool failed"

      # .env ÌååÏùº ÏÉùÏÑ±
      - name: Create .env file from GitHub Secret
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env
          echo ".env file created"
          ls -la

      # KeystoreÏôÄ key.properties ÏÑ§Ï†ï
      - name: Setup Keystore and key.properties
        run: |
          mkdir -p android/app/keystore
          echo "${{ secrets.DEBUG_KEYSTORE }}" | base64 -d > android/app/keystore/key.jks || echo "Base64 decoding failed"
          echo "Keystore created from DEBUG_KEYSTORE"
          ls -la android/app/keystore
          echo "storeFile=app/keystore/key.jks" > android/key.properties
          echo "storePassword=android" >> android/key.properties
          echo "keyAlias=androiddebugkey" >> android/key.properties
          echo "keyPassword=android" >> android/key.properties
          echo "key.properties created"
          ls -la android/

      # Google-services.json ÏÉùÏÑ±
      - name: Create Google-services.json
        run: |
          cat << 'EOF' > android/app/google-services.json
          ${{ secrets.GOOGLE_SERVICES_JSON }}
          EOF
          echo "‚úÖ Google-services.json ÏÉùÏÑ± ÏôÑÎ£å"
          ls -la android/app/

      # Flutter ÏÑ§Ï†ï Î∞è Î≤ÑÏ†Ñ ÌôïÏù∏
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
          cache-key: flutter-${{ runner.os }}-${{ env.FLUTTER_VERSION }}

      - name: Verify Flutter version
        run: |
          echo "Flutter setup completed"
          flutter --version

      # Flutter Î∞è Gradle Ï∫êÏãú
      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-flutter-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-flutter-pub-

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/build.gradle', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # ÌîÑÎ°úÏ†ùÌä∏ ÏùòÏ°¥ÏÑ± ÏÑ§Ïπò
      - name: Install dependencies
        run: |
          flutter pub get
          echo "Dependencies installed"
          ls -la

      # Gradle ÏÖãÏóÖ
      - name: Setup Gradle
        working-directory: android
        run: |
          chmod +x gradlew
          echo "Gradle wrapper permissions set"

      # Java ÏÑ§Ï†ï Î∞è Î≤ÑÏ†Ñ ÌôïÏù∏
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: ${{ env.JAVA_VERSION }}

      - name: Verify Java version
        run: |
          echo "Java setup completed"
          java -version

      # Android SDK ÏÑ§Ï†ï Î∞è ÌôïÏù∏
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Verify Android SDK setup
        run: echo "Android SDK setup completed"

      # Ruby ÏÑ§Ï†ï Î∞è ÌôïÏù∏
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4.1"

      - name: Verify Ruby version
        run: |
          echo "Ruby setup completed"
          ruby -v

      # Fastlane ÏÑ§Ïπò
      - name: Install Fastlane
        run: |
          gem install fastlane
          echo "Fastlane installed"
          fastlane --version

      # ÌòÑÏû¨ Î≤ÑÏ†Ñ Ï†ïÎ≥¥ Î∞è ÏßßÏùÄ Ïª§Î∞ã Ìï¥Ïãú Í≥ÑÏÇ∞
      - name: Get version info and calculate short commit hash
        id: version_info
        run: |
          CURRENT_VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
          VERSION=$(echo $CURRENT_VERSION | cut -d'+' -f1)
          BUILD_NUMBER=$(echo $CURRENT_VERSION | cut -d'+' -f2)
          SHORT_COMMIT_HASH=$(echo ${{ github.sha }} | cut -c1-7)

          echo "CURRENT_VERSION=$CURRENT_VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV
          echo "SHORT_COMMIT_HASH=$SHORT_COMMIT_HASH" >> $GITHUB_ENV

          echo "ÌòÑÏû¨ Î≤ÑÏ†Ñ: $CURRENT_VERSION"
          echo "ÏßßÏùÄ Ïª§Î∞ã Ìï¥Ïãú: $SHORT_COMMIT_HASH"

      # FastlaneÏùÑ Ïù¥Ïö©ÌïòÏó¨ APK ÎπåÎìú (Î¶¥Î¶¨Ïä§ ÎπåÎìú Ïú†ÏßÄ)
      - name: Build APK with Fastlane
        run: |
          cd android
          fastlane build --verbose
          ls -la ../build/app/outputs/flutter-apk/ || true
          echo "APK built with Fastlane"

      # APK ÌååÏùº Ïù¥Î¶Ñ Î≥ÄÍ≤Ω Î∞è Ï§ÄÎπÑ
      - name: Rename and Prepare APK
        run: |
          mkdir -p ./android/app/build/outputs/apk/release/
          mv ./build/app/outputs/flutter-apk/app-release.apk ./android/app/build/outputs/apk/release/${{ env.PROJECT_NAME }}-v${{ env.VERSION }}-${{ env.SHORT_COMMIT_HASH }}.apk
          echo "APK renamed to ${{ env.PROJECT_NAME }}-v${{ env.VERSION }}-${{ env.SHORT_COMMIT_HASH }}.apk"
          ls -la ./android/app/build/outputs/apk/release/

      # APKÎ•º ÏïÑÌã∞Ìå©Ìä∏Î°ú ÏóÖÎ°úÎìú
      - name: Upload APK as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PROJECT_NAME }}-apk
          path: ./android/app/build/outputs/apk/release/${{ env.PROJECT_NAME }}-v${{ env.VERSION }}-${{ env.SHORT_COMMIT_HASH }}.apk
          retention-days: 1

  deploy-android:
    name: Deploy Android APK
    runs-on: ubuntu-latest
    needs: build-android
    if: github.ref == 'refs/heads/deploy'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: List repository contents for deploy
        run: |
          echo "Repository checked out for deploy"
          ls -la

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y smbclient jq
          echo "SMB and jq dependencies installed"

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.PROJECT_NAME }}-apk
          path: android/app/build/outputs/

      - name: List downloaded structure (Debug)
        run: |
          ls -alR android/app/build/outputs
          echo "Downloaded structure listed"

      - name: Find APK file
        run: |
          APK_FILE=$(find android/app/build/outputs/ -name "*.apk" | head -n 1)
          echo "APK_FILE=$APK_FILE" >> $GITHUB_ENV
          APK_NAME=$(basename "$APK_FILE")
          echo "APK_NAME=$APK_NAME" >> $GITHUB_ENV
          echo "APK file found: $APK_FILE"

      - name: Upload files to Synology NAS via SMB
        env:
          SMB_USERNAME: ${{ secrets.SERVER_USER }}
          SMB_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          SMB_SERVER=${{ secrets.SERVER_HOST }}
          SMB_PORT=${{ env.SMB_PORT }}
          SMB_SHARE=${{ env.SMB_SHARE }}
          SMB_PATH="/${{ env.PROJECT_NAME }}${{ env.SMB_PATH_ANDROID }}"
          echo "Uploading APK file ${{ env.APK_NAME }} to SMB..."
          echo "SMB Path: $SMB_PATH"
          smbclient "//$SMB_SERVER/$SMB_SHARE" -p "$SMB_PORT" -U "$SMB_USERNAME%$SMB_PASSWORD" -m SMB3 -d 10 -c "mkdir $SMB_PATH; cd $SMB_PATH; put ${{ env.APK_FILE }} ${{ env.APK_NAME }}"
          echo "APK uploaded to SMB"

      - name: Update CICD history JSON
        env:
          SMB_USERNAME: ${{ secrets.SERVER_USER }}
          SMB_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          export TZ='Asia/Seoul'
          BUILD_DATE=$(date +"%Y-%m-%d %H:%M")
          FILE_SIZE=$(stat -c%s "${{ env.APK_FILE }}")
          COMMIT_LINK="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
          FULL_COMMIT_HASH="${{ github.sha }}"
          HISTORY_FILE="${{ env.PROJECT_NAME }}-android-cicd-history.json"

          NEW_BUILD_INFO=$(jq -n \
            --arg apk_name "${{ env.APK_NAME }}" \
            --arg file_size "$FILE_SIZE" \
            --arg build_date "$BUILD_DATE" \
            --arg commit_link "$COMMIT_LINK" \
            --arg full_commit_hash "$FULL_COMMIT_HASH" \
            '{apk_name: $apk_name, file_size: $file_size, build_date: $build_date, commit_link: $commit_link, full_commit_hash: $full_commit_hash}')

          SMB_SERVER=${{ secrets.SERVER_HOST }}
          SMB_PORT=${{ env.SMB_PORT }}
          SMB_SHARE=${{ env.SMB_SHARE }}
          SMB_PATH="/${{ env.PROJECT_NAME }}${{ env.SMB_PATH_ANDROID }}"

          smbclient "//$SMB_SERVER/$SMB_SHARE" -p "$SMB_PORT" -U "$SMB_USERNAME%$SMB_PASSWORD" -m SMB3 -d 10 -c "cd $SMB_PATH; get $HISTORY_FILE" || echo '{"files": []}' > $HISTORY_FILE
          echo "Downloaded or initialized $HISTORY_FILE"
          cat $HISTORY_FILE

          jq --argjson new_build "$NEW_BUILD_INFO" '.files += [$new_build]' $HISTORY_FILE > updated.json
          echo "Updated $HISTORY_FILE with new build info"
          cat updated.json

          smbclient "//$SMB_SERVER/$SMB_SHARE" -p "$SMB_PORT" -U "$SMB_USERNAME%$SMB_PASSWORD" -m SMB3 -d 10 -c "cd $SMB_PATH; put updated.json $HISTORY_FILE"
          echo "Updated $HISTORY_FILE uploaded to SMB"
